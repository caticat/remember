<html>
    <head>
        <!-- 这只是一个粗糙的辅助记忆数字编码的工具,不要对它的功能有太大的期望,最终还是要靠自己记忆(by:老番) -->
        <meta charset="UTF-8"/>
        <style>
            .cssTextArea
            {
                width:100%;
            }
        </style>
        <script src="number_code.js" type="text/javascript" charset="utf-8"></script>
        <script type="text/javascript">
            // 固定数据
            // const data = {
            //     1:"1的数字编码",
            //     "2":"2的数字编码",
            // };

            // 生成数据
            const arr = function(data) {
                let ret = Array();
                for (let k in data) {
                    ret.push(k);
                }
                return ret;
            }(data);

            // 状态
            const PageState = {
                Start:0,
                Progress:1,
                Finish:2,
                Pause:3,
                Resume:4,
            };
            const SequenceState = {
                Random:0,
                Forward:1,
                Backward:2,
            };
            const SINGLE_WORD_TIME_LIMIT = 2; // 超过X秒的编码都会显示出来

            // 动态数据
            let arrRandom = Array(); // 随机索引数组
            let curIndex = -1; // 当前出题索引
            let timeBegin = -1; // 记录总用时
            let questionLen = arr.length; // 题目数量
            let timeBeginQuestion = -1; // 当前答题初始时间
            let timeBeginPause = 0; // 暂停时长
            let mapTimeCost = {}; // 耗时统计

            // 初始
            window.onload = function () {
                document.getElementById("questionMaxLength").min = 1;
                document.getElementById("questionMaxLength").max = questionLen;
                document.getElementById("questionMaxLength").value = questionLen;
                document.getElementById("uiQuestionMaxLength").value = questionLen;

                reset();

                // 说明
                document.getElementById("uiLog").style.display = "none";
                document.getElementById("uiLog").value = "老番的碎碎念:\n1. 这是本人出于兴趣完善的背诵数字编码的小工具.\n2. 仅供学习使用\n3. 编码内容没有上传到任何公共平台保存\n4. 只限在学习群内使用\n5. 本人强迫症,后续可能会有更新,但是应该不会再发出来了,更新会提交到https://github.com/caticat/remember/tree/master/number_code这里,有需求可以自取(欢迎提bug,或者推送更新过来)\n6. 代码随便改\n7. 没有图片是因为不好整合到一个文件中,图片又不能传到外网~囧";
                document.getElementById("uiLog").rows = 10;
            };

            // 切换页面状态
            function switchPageState(state) {
                // 离开状态
                // TODO 功能待实现,初始化数据获取
                // switch (pageState) {
                //     case PageState.Start:
                //
                // }

                // 进入状态
                document.getElementById("pageStart").style.display = "none";
                document.getElementById("pageProgress").style.display = "none";
                document.getElementById("pageFinish").style.display = "none";
                document.getElementById("pagePause").style.display = "none";
                switch (state) {
                    case PageState.Start:
                        document.getElementById("pageStart").style.display = "";
                        break;
                    case PageState.Progress:
                        // 处理数据
                        // 出题长度
                        questionLen = parseInt(document.getElementById("questionMaxLength").value);
                        // console.log("长度:"+questionLen + ",文字:" + document.getElementById("questionMaxLength").value);
                        // 出题顺序
                        const l = arr.length;
                        arrRandom = arr.slice();

                        let sequence = SequenceState.Random;
                        document.getElementsByName("sequence").forEach(function (node, value){ // MARK: 这里有个循环过度的问题,无视了,抛异常什么的太难看了
                            if (node.checked) {
                                sequence = value;
                            }
                        });

                        switch (sequence) {
                            case SequenceState.Random:
                                let key = 0;
                                let tmp = 0;
                                for (let i = 0; i < l; i++) {
                                    key = rand(0, l-1);
                                    tmp = arrRandom[key];
                                    arrRandom[key] = arrRandom[i];
                                    arrRandom[i] = tmp;
                                }
                                break;
                            case SequenceState.Forward:
                                break;
                            case SequenceState.Backward:
                                arrRandom = arr.reverse();
                                break;
                            default:
                                alert("重置时,不知道按照什么顺序来进行出题");
                                return;
                        }
                        timeBegin = parseInt((new Date()).getTime() / 1000);
                        ask();

                        // 显示页面
                        document.getElementById("pageProgress").style.display = "";
                        break;
                    case PageState.Finish:
                        // 处理数据
                        let timeNow = parseInt((new Date()).getTime() / 1000);
                        let duration = timeNow - timeBegin;
                        let average = duration / (curIndex + 1);
                        document.getElementById("totalCostTime").innerHTML = "当前用时:"+getTimeStr(duration)+",平均用时:"+getTimeStr(average);

                        // 最耗时统计
                        let arrTimeCost = Array();
                        for (let key in mapTimeCost) {
                            arrTimeCost.push({index:key,cost:mapTimeCost[key].cost,show:mapTimeCost[key].show});
                        }
                        arrTimeCost.sort(function (key){
                            return function (a, b) {
                                // console.log(key+",a:"+a[key]+",b:"+b[key]);
                                if (a[key] < b[key]) {
                                    return 1;
                                } else if (a[key] == b[key]) {
                                    return 0;
                                } else {
                                    return -1;
                                }
                            }
                        }("cost"));
                        document.getElementById("labelCostTime").innerText = "耗时超过"+SINGLE_WORD_TIME_LIMIT+"秒的编码";
                        let strTimeCost = "";
                        let rows = 0;
                        for (let i = 0; i < arrTimeCost.length; i++) {
                            if (arrTimeCost[i].cost >= SINGLE_WORD_TIME_LIMIT) {
                                strTimeCost += arrRandom[arrTimeCost[i].index] + "->" + data[arrRandom[arrTimeCost[i].index]] + ":用时:" + getTimeStr(arrTimeCost[i].cost) + "\n";
                                rows++;
                            } else {
                                break;
                            }
                        }
                        document.getElementById("timeCost").rows = rows + 2;
                        document.getElementById("timeCost").value = strTimeCost;

                        // 显示答案统计
                        if (document.getElementById("showAnswerDirectly").checked) {
                            document.getElementById("divAnswerShowed").style.display = "none";
                        } else {
                            document.getElementById("divAnswerShowed").style.display = "";
                            let strAnswerShowed = "";
                            let rows = 0;
                            for (let i = 0; i < arrTimeCost.length; i++) {
                                if (arrTimeCost[i].show) {
                                    strAnswerShowed += arrRandom[arrTimeCost[i].index] + "->" + data[arrRandom[arrTimeCost[i].index]] + "\n";
                                    rows++;
                                }
                            }
                            document.getElementById("answerShowed").rows = rows + 2;
                            document.getElementById("answerShowed").value = strAnswerShowed;
                            if (rows > 0) {
                                document.getElementById("labelAnswerShowed").innerText = "所有显示过答案的编码";
                            } else {
                                document.getElementById("labelAnswerShowed").innerText = "没有显示过答案的编码";
                            }
                        }

                        // 显示页面
                        document.getElementById("pageFinish").style.display = "";
                        break;
                    case PageState.Pause:
                        document.getElementById("pagePause").style.display = "";
                        timeBeginPause = parseInt((new Date()).getTime() / 1000);
                        break;
                    case PageState.Resume:
                        let pauseTime = (parseInt((new Date()).getTime() / 1000) - timeBeginPause);
                        timeBegin += pauseTime;
                        timeBeginQuestion += pauseTime;
                        timeBeginPause = 0;
                        document.getElementById("pageProgress").style.display = "";
                        break;
                    default:
                        return;
                }
            }

            // 重置
            function reset() {
                curIndex = 0;
                mapTimeCost = {};
                document.getElementById("costTime").innerHTML = "";

                switchPageState(PageState.Start)
            }

            // 出题
            function ask() {
                if (curIndex >= arrRandom.length) {
                    alert("Done!");
                    return;
                }
                // console.log(curIndex, arrRandom[curIndex], data[arrRandom[curIndex]]);
                // console.log(document.getElementById("reverse").checked);
                if (document.getElementById("reverse").checked) {
                    document.getElementById("question").innerHTML = data[arrRandom[curIndex]];
                } else {
                    document.getElementById("question").innerHTML = arrRandom[curIndex];
                }
                document.getElementById("answer").innerHTML = "";
                document.getElementById("progress").innerHTML = "当前进度:"+(curIndex + 1)+"/"+questionLen;

                // 时间统计
                timeBeginQuestion = parseInt((new Date()).getTime() / 1000);

                // 直接显示答案
                if (document.getElementById("showAnswerDirectly").checked) {
                    ans()
                }
            }

            // 显示答案
            function ans() {
                if (curIndex >= questionLen) {
                    alert("No Answer for key:[" + curIndex +"]. Index Out Off Range!");
                    return;
                }
                if (document.getElementById("reverse").checked) {
                    document.getElementById("answer").innerHTML = arrRandom[curIndex];
                } else {
                    document.getElementById("answer").innerHTML = data[arrRandom[curIndex]];
                }
            }

            // 下一个
            function next() {
                // 时间统计
                mapTimeCost[curIndex] = {
                    cost:(parseInt((new Date()).getTime() / 1000) - timeBeginQuestion),
                    show:(document.getElementById("answer").innerText != ""),
                };

                if (curIndex + 1 >= questionLen) {
                    switchPageState(PageState.Finish);
                    return;
                }

                curIndex += 1;
                ask();
                showTime();
            }

            // 说明展示
            function switchLog(ui) {
                if (ui.innerText == "+") {
                    ui.innerText = "-";
                    document.getElementById("uiLog").style.display = "";
                } else {
                    ui.innerText = "+";
                    document.getElementById("uiLog").style.display = "none";
                }
            }

            // 滑块变更
            function onRangeChanged(ui) {
                document.getElementById("uiQuestionMaxLength").value = ui.value;
            }

            // 答题数量长度变更
            function onQuestionMaxLengthChanged(ui) {
                if (!ui.value) {
                    ui.value = questionLen;
                    return
                }
                let len = parseInt(ui.value);
                if (len > arr.length) {
                    len = questionLen;
                } else if (len < 1) {
                    len = questionLen;
                }
                ui.value = len;
                document.getElementById("questionMaxLength").value = len;
            }

            // 恢复计划答题最大值
            function resumeQuestionMaxLength() {
                document.getElementById("questionMaxLength").value = arr.length;
            }

            // 直接显示答案状态变更
            function onShowAnswerDirectlyChanged(ui) {
                if (ui.checked) {
                    document.getElementById("showAnswer").style.display = "none";
                    ans()
                } else {
                    document.getElementById("showAnswer").style.display = "";
                    document.getElementById("answer").innerHTML = "";
                }
            }

            // 显示时间
            function showTime() {
                let timeNow = parseInt((new Date()).getTime() / 1000);
                let duration = timeNow - timeBegin;
                let average = 0;
                if (curIndex > 0) {
                    average = duration / curIndex;
                }
                document.getElementById("costTime").innerHTML = "当前用时:"+getTimeStr(duration)+",平均用时:"+getTimeStr(average);
            }

            // 获取时间间隔字符串
            function getTimeStr(duration) {
                let minute = parseInt(duration / 60);
                let second = duration % 60;
                let ret = "";
                if (minute > 0) {
                    ret += minute + "分"
                }
                if ((second > 0) || (minute == 0)) {
                    ret += (parseInt(second * 100) / 100) + "秒"
                }
                return ret
            }

            // 随机
            function rand(min, max) {
                if (min > max) {
                    let tmp = min;
                    min = max;
                    max = tmp;
                }
                return parseInt(Math.random() * (max - min + 1) + min, 10);
            }
        </script>
    </head>
    <body>
        <div id="pageStart">
            <div>
                <div>
                    <div>
                        <label>测试题目数量:</label>
                    </div>
                    <div>
                        <input type="range" id="questionMaxLength" onchange="onRangeChanged(this)" title="questionLengthRange"/>
                    </div>
                    <div>
                        <input id="uiQuestionMaxLength" type="number" min="1" step="10" title="测试题目数量" onblur="onQuestionMaxLengthChanged(this)"/>
                        <button onclick="resumeQuestionMaxLength()">最大值</button>
                    </div>
                </div>
                <!--<div>-->
                    <!--<label>随机</label><input type="radio" name="sequence" title="随机" value="SequenceState.Random" checked="checked"/>-->
                    <!--<label>顺序</label><input type="radio" name="sequence" title="正向" value="SequenceState.Forward"/>-->
                    <!--<label>倒序</label><input type="radio" name="sequence" title="反向" value="SequenceState.Backward"/>-->
                <!--</div>-->
                <div>
                    <label>反向记忆</label><input id="reverse" type="checkbox"/>
                </div>
                <div>
                    <button onclick="switchPageState(PageState.Progress)">开始</button>
                </div>
                <div>
                    <button onclick="switchLog(this)">+</button>
                </div>
                <div>
                    <textarea id="uiLog" title="说明" class="cssTextArea" readonly disabled></textarea>
                </div>
            </div>
        </div>
        <div id="pageProgress">
            <div>
                <label>问题</label>
                <label>答案</label>
            </div>
            <div>
                <label id="question"></label>
                <label id="answer"></label>
            </div>
            <div>
                <button onclick="ans()" id="showAnswer">显示答案</button>
            </div>
            <div>
                <label>直接显示答案</label><input id="showAnswerDirectly" type="checkbox" onchange="onShowAnswerDirectlyChanged(this)"/>
            </div>
            <div>
                <button onclick="next()">下一个</button>
            </div>
            <div>
                <label id="progress"></label>
            </div>
            <div>
                <label id="costTime"></label>
            </div>
            <div>
                <button onclick="switchPageState(PageState.Pause)">暂停</button>
            </div>
        </div>
        <div id="pageFinish">
            <div>
                <label id="totalCostTime"></label>
            </div>
            <div>
                <button onclick="reset()">重新开始</button>
            </div>
            <div>
                <label id="labelCostTime"></label>
            </div>
            <div>
                <textarea id="timeCost" title="消耗时间显示" class="cssTextArea" readonly disabled></textarea>
            </div>
            <div id="divAnswerShowed">
                <div>
                    <label id="labelAnswerShowed"></label>
                </div>
                <div>
                    <textarea id="answerShowed" title="显示过答案的" class="cssTextArea" readonly disabled></textarea>
                </div>
            </div>
        </div>
        <div id="pagePause">
            <div>
                <button onclick="switchPageState(PageState.Resume)">恢复</button>
            </div>
        </div>
    </body>
</html>
